## Serverless Framework のインストール

まずは serverless コマンドを利用可能にするため、以下のコマンドで serverless をインストールします。

```bash
$ npm install -g serverless
```

インストールが完了したことを確認するために、以下のコマンドでバージョンを確認しておきましょう。

```bash
$ serverless -v
Framework Core: 1.50.1
Plugin: 1.3.9
SDK: 2.1.0
```

serverless コマンドのセットアップが完了したら実際にプロジェクトを作成していきます。
以下のコマンドで、 Serverless Framework でのアプリケーション開発に必要なファイルがセットアップされます。

```bash
$ serverless create --template aws-nodejs --path my_first_slsapp
$ cd my_first_slsapp
```

作成されたフォルダに移動して、以下のコマンドを実行することで serverless のアプリケーションをデプロイすることが出来ます。

```bash
$ serverless deploy --aws-profile my_first_slsapp  --region ap-northeast-1
```

上記のコマンドを実行することで、作成したアプリケーションが、
AWS 環境上にデプロイされます。

### AWS リソースの確認

Serverless で作成したアプリケーションは、AWS 上では Lambda と呼ばれるサービス上に展開され、
それぞれのサービス画面からその状況をから確認することが可能です。

AWS Lambda は AWS の FaaS サービスで、プログラムで記述した関数の処理を、AWS 環境上で実行させることが可能です。
AWS Lambdaのデプロイ状態は、以下のURL から確認可能です。
実際にアクセスして、 `my-first-slsapp-dev-hello` という名前のサービスがそんざいしていることを確認しておきましょう。

https://ap-northeast-1.console.aws.amazon.com/lambda/home?region=ap-northeast-1#/functions

## REST API の作成

`serverless.yml` を触る

```yaml
functions:
  hello:
    handler: handler.hello
    events:
      - http:
          path: hello
          method: get
```

で、デプロイする。

```bash
$ serverless deploy --aws-profile my_first_slsapp  --region ap-northeast-1
...
Service Information
service: my-first-slsapp
stage: dev
region: ap-northeast-1
stack: my-first-slsapp-dev
resources: 10
api keys:
  None
endpoints:
  GET - https://s6j8rov4c3.execute-api.ap-northeast-1.amazonaws.com/dev/hello
functions:
  hello: my-first-slsapp-dev-hello
layers:
  None
Serverless: Run the "serverless" command to setup monitoring, troubleshooting and testing.
```

デプロイが正常に実行されると、REST API のエンドポイントが画面上に表示されるため、
これを利用して Postman 等の REST API クライアントソフトで、REST APIの動作を確認することが出来ます。

表示されたURLにリクエストを発行して以下のようなレスポンスが取得できればデプロイは成功です。

handler.js を触って...

### AWS リソースの確認

AWS リソースの確認

API Gateway 

https://ap-northeast-1.console.aws.amazon.com/apigateway/main/apis?region=ap-northeast-1


## Serverless Webpack のセットアップ

より本格的なアプリケーション開発を進めるために、
webpack を利用した環境構築を進めましょう。

まずは、 npm init で `package.json` を作成します。

```bash
$ npm init
```

続いて必要なモジュール群を以下のコマンドでインストールします。

```bash
$ npm i serverless-webpack webpack webpack-node-externals babel-loader @babel/core
```

`webpack.config.js` を以下で作成

```js
const path = require('path');
const slsw = require('serverless-webpack');
const nodeExternals = require('webpack-node-externals');

// webpack.config.js

module.exports = {
    entry: slsw.lib.entries,
    target: 'node',
    mode: slsw.lib.webpack.isLocal ? 'development': 'production',
    optimization: {
        // We no not want to minimize our code.
        minimize: false
    },
    performance: {
        // Turn off size warnings for entry points
        hints: false
    },
    devtool: 'nosources-source-map',
    externals: [nodeExternals()],
    module: {
        rules: [
            {
                test: /\.js$/,
                exclude: /node_modules/,
                use: [
                    {
                        loader: 'babel-loader'
                    }
                ],
            }
        ]
    },
    plugins: [ ],
    resolve: {
        alias: {
            "@": path.resolve(__dirname),
        }
    }
};
```

プロジェクトルートにソースコードを置くのは落ち着きが悪いので、
`src` フォルダを作成して、コードを移動させましょう。

```bash
$ mkdir src
$ mv handler.js src/handler.js
```

最後に `serverless.yml` を以下の形式で書き換えれば、完了です。

```yaml
# https://www.serverless.com/framework/docs/providers/aws/guide/serverless.yml/
service: my-first-slsapp

provider:
  name: aws
  runtime: nodejs12.x
plugins:
  - serverless-webpack

custom:
  webpack:
    webpackConfig: ./webpack.config.js
    includeModules: true

functions:
  hello:
    handler: src/handler.hello
    events:
      - http:
          path: hello
          method: get
```

以下のデプロイコマンドを実行して正しくデプロイが実行されることを確認してみましょう。

```
$ serverless deploy --aws-profile my_first_slsapp  --region ap-northeast-1
```

## デプロイしたアプリケーションの削除

Serverless Framework を用いて用意したアプリケーションは、簡単にAWS上から削除することが可能です。
以下のコマンドを実行することで、アプリケーションで用意したリソースを一括で削除することが可能です。

```
$ serverless remove --aws-profile my_first_slsapp
```

コマンド実行後、AWSの管理画面にアクセスし、API Gateway や Lamdbaなどのリソースが適切に削除されていることを確認しておきましょう。


